version: 2.1
executors:
  podman-executor:
    docker:
      - image: quay.io/podman/podman:latest

workflows:
  build-and-deploy:
    jobs:
      - run-me

jobs:
  run-me:
    executor: podman-executor
    machine: true
    resource_class: ng0cth1nh/demo-server-1
    steps:
      - run:
          name: Clone git repository
          command: git clone https://github.com/ng0cth1nh/demo-go.git -b $CIRCLE_BRANCH .
      - run:
          name: Check podman
          command: podman version
      - run:
          name: Build
          command: podman build . -t docker-registry.chop.dev:5000/$CIRCLE_PROJECT_REPONAME:$CIRCLE_BRANCH
      - run:
          name: Push to docker registry
          command: podman push docker-registry.chop.dev:5000/$CIRCLE_PROJECT_REPONAME:$CIRCLE_BRANCH